{% extends "base.html" %}

{% block title %}AI Insights - Exelio{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2">
            <i class="fas fa-brain me-2 text-primary"></i>AI Insights
        </h1>
        <p class="text-muted mb-0">
            <i class="fas fa-file-excel me-1"></i>{{ upload.original_filename }}
            <span class="mx-2">â€¢</span>
            <i class="fas fa-clock me-1"></i>{{ upload.upload_time.strftime('%Y-%m-%d %H:%M') }}
        </p>
    </div>
    <div>
        <a href="{{ url_for('view_data', upload_id=upload.id) }}" class="btn btn-outline-primary me-2">
            <i class="fas fa-chart-bar me-2"></i>Visualize
        </a>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Dashboard
        </a>
    </div>
</div>

<div class="row">
    <!-- Data Quality Report -->
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt me-2"></i>Data Quality Report
                </h5>
            </div>
            <div class="card-body">
                {% if quality_report and not quality_report.get('error') %}
                    <div class="text-center mb-3">
                        <div class="progress-circle">
                            <div class="progress-circle-content">
                                <span class="display-4 fw-bold text-primary">{{ "%.0f"|format(quality_report.quality_score) }}%</span>
                                <small class="text-muted d-block" style="font-size: 0.75rem; margin-top: -5px;">Quality Score</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <div class="border-end">
                                <h6 class="text-primary">{{ quality_report.total_rows }}</h6>
                                <small class="text-muted">Total Rows</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h6 class="text-info">{{ quality_report.total_columns }}</h6>
                            <small class="text-muted">Columns</small>
                        </div>
                    </div>
                    
                    <h6 class="mt-3">Missing Data Analysis</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Column</th>
                                    <th>Missing %</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for column, missing_info in quality_report.missing_data.items() %}
                                <tr>
                                    <td>{{ column[:15] }}{% if column|length > 15 %}...{% endif %}</td>
                                    <td>
                                        {% if missing_info.percentage > 20 %}
                                            <span class="badge bg-danger">{{ missing_info.percentage }}%</span>
                                        {% elif missing_info.percentage > 5 %}
                                            <span class="badge bg-warning">{{ missing_info.percentage }}%</span>
                                        {% else %}
                                            <span class="badge bg-success">{{ missing_info.percentage }}%</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-exclamation-triangle text-warning fa-2x mb-2"></i>
                        <p class="text-muted">Unable to generate quality report</p>
                        {% if quality_report.get('error') %}
                            <small class="text-danger">{{ quality_report.error }}</small>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- AI Analysis Results -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-robot me-2"></i>AI Analysis Results
                </h5>
            </div>
            <div class="card-body">
                {% if ai_analysis %}
                    <!-- Key Insights -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-lightbulb me-2"></i>Key Insights
                        </h6>
                        
                        {% if ai_analysis.key_insights %}
                            <div class="row g-3">
                                {% for insight in ai_analysis.key_insights %}
                                <div class="col-md-6">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body p-3">
                                            <div class="d-flex align-items-start">
                                                <div class="me-3">
                                                    {% if insight.insight_type == 'trend' %}
                                                        <i class="fas fa-trending-up text-success"></i>
                                                    {% elif insight.insight_type == 'pattern' %}
                                                        <i class="fas fa-search text-info"></i>
                                                    {% elif insight.insight_type == 'anomaly' %}
                                                        <i class="fas fa-exclamation text-warning"></i>
                                                    {% else %}
                                                        <i class="fas fa-info-circle text-primary"></i>
                                                    {% endif %}
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="card-title">{{ insight.title }}</h6>
                                                    <p class="card-text small">{{ insight.description }}</p>
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="badge bg-secondary">{{ insight.insight_type }}</span>
                                                        <small class="text-muted">{{ "%.0f"|format(insight.confidence * 100) }}% confidence</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-3">
                                <i class="fas fa-search fa-2x text-muted mb-2"></i>
                                <p class="text-muted">No specific insights found in the data</p>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Recommendations -->
                    {% if ai_analysis.recommendations %}
                    <div class="mb-4">
                        <h6 class="text-success mb-3">
                            <i class="fas fa-thumbs-up me-2"></i>Recommendations
                        </h6>
                        <ul class="list-group list-group-flush">
                            {% for recommendation in ai_analysis.recommendations %}
                            <li class="list-group-item px-0">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                {{ recommendation }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <!-- Data Summary -->
                    <div class="row text-center bg-light rounded p-3">
                        <div class="col-md-6">
                            <h6 class="text-primary">{{ ai_analysis.total_rows }}</h6>
                            <small class="text-muted">Rows Analyzed</small>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-info">{{ ai_analysis.columns_analyzed|length }}</h6>
                            <small class="text-muted">Columns Analyzed</small>
                        </div>
                    </div>
                    
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-robot fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">AI Analysis Unavailable</h5>
                        <p class="text-muted">Unable to generate AI insights for this dataset.</p>
                        <a href="{{ url_for('view_data', upload_id=upload.id) }}" class="btn btn-primary">
                            <i class="fas fa-chart-bar me-2"></i>Create Charts Instead
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="card-title">Next Steps</h6>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('view_data', upload_id=upload.id) }}" class="btn btn-outline-primary">
                        <i class="fas fa-chart-bar me-2"></i>Create Visualizations
                    </a>
                    <button type="button" class="btn btn-outline-success" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>Print Report
                    </button>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-tachometer-alt me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.progress-circle {
    position: relative;
    display: inline-block;
    width: 140px;
    height: 140px;
    border-radius: 50%;
    background: conic-gradient(var(--bs-primary) {{ "%.0f"|format(quality_report.quality_score * 3.6) if quality_report and not quality_report.get('error') else 0 }}deg, var(--bs-gray-300) 0deg);
    display: flex;
    align-items: center;
    justify-content: center;
}

.progress-circle::before {
    content: '';
    position: absolute;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: var(--bs-body-bg);
}

.progress-circle-content {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    line-height: 1.2;
}
</style>
{% endblock %}